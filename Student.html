<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polling Portal</title>
    
    <!-- FontAwesome for icons -->
    <script src="https://kit.fontawesome.com/8fada4f271.js" crossorigin="anonymous"></script>
    
    <!-- CSS Stylesheet -->
    <link rel="stylesheet" href="CSS/student.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="nav">
            <p>STUDENT Polling Portal</p>
            <a href="index.html"><i class="fa-solid fa-house"></i></a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <p id="questionDisplay">Loading Question...</p>
        
        <!-- Form for Poll Submission -->
        <form class="form" name="submit-to-google-sheet">
            <input type="text" name="Name" placeholder="Your Name" required>
            <input type="text" name="ID" placeholder="Your ID" required>
            <input type="text" name="message" placeholder="Your msg" required>
            <button type="submit">Submit</button>
        </form>

        <!-- Loading Indicator -->
        <div id="loader" style="display:none;">
            <p>Loading...</p>
        </div>
        
        <!-- Success/Error Message Display -->
        <div id="msg"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDS79FNi8oEhUWKvdvNOPgEDIFSay4Wj1M",
            authDomain: "infinity-try.firebaseapp.com",
            projectId: "infinity-try",
            storageBucket: "infinity-try.appspot.com",
            messagingSenderId: "326631894819",
            appId: "1:326631894819:web:6b50d91212a260af792696",
            measurementId: "G-W55EB5PVH7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Anonymous Authentication
        firebase.auth().signInAnonymously()
            .then(() => {
                console.log("Signed in anonymously");
                fetchLatestQuestion(); // Fetch question after login
            })
            .catch(error => console.error("Authentication Error:", error));

        // Function to Fetch Latest Question from Firestore
        function fetchLatestQuestion() {
            db.collection("Questions") // Ensure correct collection name (case-sensitive)
                .orderBy("timestamp", "desc")
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            const latestQuestion = doc.data().question; // Ensure correct field name
                            console.log("Latest Question:", latestQuestion);
                            document.getElementById("questionDisplay").innerText = latestQuestion;
                        });
                    } else {
                        console.warn("No questions found in Firestore.");
                        document.getElementById("questionDisplay").innerText = "No questions available.";
                    }
                })
                .catch(error => console.error("Error fetching question:", error));
        }

        // Call function to fetch the latest question
        fetchLatestQuestion();

        // Google Sheets Form Submission
        const scriptURL = 'https://script.google.com/macros/s/AKfycby14guX3CH8WQGu1JzAHekENlG1m-11qbCm6-Ua-jGfelb59DOKvkZ8lXIZXqJvJouYRg/exec';
        const form = document.forms['submit-to-google-sheet'];
        const msg = document.getElementById("msg");
        const loader = document.getElementById("loader");

        // Form Submit Event Listener
        form.addEventListener('submit', e => {
            e.preventDefault();
            loader.style.display = "block";
            msg.style.display = "none";

            fetch(scriptURL, { method: 'POST', body: new FormData(form) })
                .then(response => {
                    loader.style.display = "none";
                    msg.innerHTML = "Message sent SUCCESSFULLY";
                    msg.style.display = "block";

                    setTimeout(() => {
                        msg.innerHTML = "";
                        msg.style.display = "none";
                    }, 5000);

                    form.reset();
                })
                .catch(error => {
                    loader.style.display = "none";
                    msg.innerHTML = "Error! " + error.message;
                    msg.style.display = "block";
                });
        });
    </script>
</body>
</html>
